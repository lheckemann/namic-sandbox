%
% Complete documentation on the extended LaTeX markup used for Insight
% documentation is available in ``Documenting Insight'', which is part
% of the standard documentation for Insight.  It may be found online
% at:
%
%     http://www.itk.org/

\documentclass{InsightArticle}

\usepackage[dvips]{graphicx}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  hyperref should be the last package to be loaded.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[dvips,
bookmarks,
bookmarksopen,
backref,
colorlinks,linkcolor={blue},citecolor={blue},urlcolor={blue},
]{hyperref}


%  This is a template for Papers to the Insight Journal.
%  It is comparable to a technical report format.

% The title should be descriptive enough for people to be able to find
% the relevant document.
\title{Conformal Flattening ITK Filter}

% Increment the release number whenever significant changes are made.
% The author and/or editor can define 'significant' however they like.
\release{0.00}

% At minimum, give your name and an email address.  You can include a
% snail-mail address if you like.
\author{Yi Gao$^{1}$ and et al $^{1}$ $^{2}$ $^{3}$}
\authoraddress{$^{1}$Georgia Institute of Technology, Atlanta, GA\\
               $^{2}$Kitware, Clifton Park, NY\\
               $^{3}$GE, Niskayuna, NY}

\begin{document}

\newif\ifpdf
\ifx\pdfoutput\undefined
  \pdffalse
\else
  \pdfoutput=1
  \pdftrue
\fi


\ifpdf
\else
   %
   % Commands for including Graphics when using latex
   %
   \DeclareGraphicsExtensions{.eps,.jpg,.gif,.tiff,.bmp,.png}
   \DeclareGraphicsRule{.jpg}{eps}{.jpg.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.gif}{eps}{.gif.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.tiff}{eps}{.tiff.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.bmp}{eps}{.bmp.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.png}{eps}{.png.bb}{`convert #1 eps:-}
\fi


\maketitle


\ifhtml
\chapter*{Front Matter\label{front}}
\fi


% The abstract should be a paragraph or two long, and describe the
% scope of the document.
\begin{abstract}
\noindent This document describes the Insight Toolkit (ITK)
Conformal Flattening filter.
\end{abstract}

\tableofcontents

The folding and wrapping of brain surface brought difficulties in obtaining a more 
intuitionistic view and the measurement of distance on the surface. In recent years, 
a number of methods have been proposed to map the surface to a plane or a sphere. 
Most of the previous methods are derived to preserve local area or length. 
In the paper of \emph{Angenent99} ( S. Angenent, et.al., On the Laplace-Beltrami 
Operator and Brain Surface Flattening), an angle preserving conformal flattening scheme is proposed.

The algorithm obtains the explicit form of flattening mapping by solving a partial 
differential equation on the surface using the finite element method(FEM). The mapping is a 
bijection and the original structure can be restored by inverse mapping.

\section{Algorithm Details}

\subsection{Mathematical manipulation}
  Denote the genu zero surface which is to be flattened as $\Sigma$. 
  $\Sigma$ can be mapped to a plane using the algorithm proposed in
  the paper \emph{Angenent99}. The mapping is conformal thus the angles are preserved.
  Further, the plane can be mapped to a sphere, using the standard stereographic
  projection.
  
  It is proved in the appendix of \emph{Angenent99} that the mapping $z$, defined on $\Sigma$,
  satisfying:  
  \begin{eqnarray}
    \triangle z = (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p 
    \label{pde}
  \end{eqnarray}
  
  in which $p$ is an (arbitrary) point on $\Sigma$. $z$ maps $\Sigma \backslash \{p\}$ to the complex plane $\mathbf{C}$.
  Then by the standard sterographic projection, the complex plane is mapped to a sphere
  without north pole.

  \subsection{Numerical scheme}
  The mapping $z$ is defined on the surface. In the numerical manipulation where
  the surface is denoted as a triangulated mesh, solving of the equation (\ref{pde})
  is carried out by FEM. 
  
  In the discrete configuration, $z$ is approximated by a piecewise linear function on the triangulated mesh.
  Denote the finite-dimensional space $PL(\Sigma)$ of piecewise linear functions on $\Sigma$. 
  To solve equation (\ref{pde}), first its right side should be approximated.
  For any function $f$ smooth in a neighborhood of $p$,
  \begin{eqnarray}
    && \int\int_{\Sigma} f (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p \mathrm{d}S \nonumber \\
    &=& - \int\int_{\Sigma}(\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})f \delta_p(w) \mathrm{d}S \nonumber \\
    &=& -(\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})\delta_p \label{rightSideOfPDE}
  \end{eqnarray}  
  Thus $\forall f \in PL(\Sigma)$, given that the point $p$ lies in the cell composed by three points $A$, $B$, and $C$, 
  the quantity of (\ref{rightSideOfPDE}) is determined by the values of $f$ on $A$, $B$, and $C$.
  
  On the triangle $\triangle ABC$, choose the $u$ and $v$ axes such that $A$ and $B$ are along $u$ axis and the positive direction
  of axis $v$ is pointing to the point $C$. So,  
  \begin{eqnarray}    
    \frac{\partial f}{\partial u} &=& \frac{f_B - f_A}{||B - A||} \nonumber \\
    \frac{\partial f}{\partial v} &=& \frac{f_C - f_E}{||C - E||} \nonumber
  \end{eqnarray}  
  in which E is the orthogonal projection of $C$ on $AB$ and can be computed by:      
  \begin{eqnarray}  
    E = A + \theta(B-A) \nonumber
  \end{eqnarray}  
  where
  \begin{eqnarray}  
    \theta = \frac{<C-A, B-A>}{||B-A||^2} \nonumber
  \end{eqnarray}  
  in which $<,>$ denotes inner product.
  
  Thus $\forall f \in PL(\Sigma)$, 
  \begin{eqnarray}  
     (\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})\delta_p = 
     \frac{f_A - f_B}{|| B - A ||} + i\frac{f_c-(f_A + \theta(f_B - f_A))}{||C - E||} \label{Rinteqn}
  \end{eqnarray}  
  
  Next we are going to perform the finite element solution of the mapping in the function space $PL(\Sigma)$.
  
  FEM theory indicates that the solver function $z=x+iy$ for equation (\ref{pde}) is the minimizer
  of the Dirichlet functional:    
  \begin{eqnarray}  
      \mathbf{D}(z):=\frac{1}{2}\int\int_{\Sigma}[ |\nabla z|^2 + 2z (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p ]\mathrm{d}S \label{DirichletFunctional}
  \end{eqnarray}      
  $z$ satisfies equation(\ref{pde}) if and only if $\forall$ smooth function $f$,    
  \begin{eqnarray}  
      \int\int_{\Sigma} \nabla z \cdot \nabla f \mathrm{d}S = (\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})|_p \label{FEM}
  \end{eqnarray}    
  To find the function in $PL(\Sigma)$ satisfying equation(\ref{FEM}), we define a set of basis $\phi_P$ in the $PL(\Sigma)$ as,
  \begin{eqnarray}  
      \phi_P(P) &=& 1 \nonumber \\
      \phi_P(Q) &=& 0, \forall Q \ne P \nonumber \\
      \phi_P(P) && is \quad linear \quad on \quad each \quad triangle \label{basis}
  \end{eqnarray}  
  Then function $z$ can be expressed as a linear combination of the basis:  
  \begin{eqnarray}  
      z = \sum_{P:\quad vertex \quad of \quad \Sigma} z_P \phi_P \label{zInBasis}
  \end{eqnarray}  
  By this we convert the original problem into solving for the complex vector $\vec{z}=(z_P)$:  
   \begin{eqnarray}  
      \sum_P z_P \int\int \nabla \phi_P \cdot \nabla \phi_Q \mathrm{d}S = \frac{\partial \phi_Q}{\partial u}(p) - i \frac{\partial \phi_Q}{\partial v}(p)
      \label{allQ}
  \end{eqnarray}  
  Denote matrix $D_{PQ}$ as
   \begin{eqnarray}  
      D_{PQ} = \int\int \nabla \phi_P \cdot \nabla \phi_Q \mathrm{d}S  \label{Dpq}
  \end{eqnarray}  
  The off-diagonal elements of $D$ can be computed by:
   \begin{eqnarray}  
      \{ \mathbf{D} \}_{P,Q } = -\frac{1}{2}(ctg\angle R + ctg\angle S), \quad P \ne Q  \label{ctg}
  \end{eqnarray}  
  \begin{figure}
  \begin{center}
    \includegraphics[width=7cm]{PntPQRS.eps} \caption{Triangle} \label{PntPQRS}
    \end{center}
  \end{figure}  
  The points are illustrated in figure (\ref{PntPQRS}).  
  
  Also, since
   \begin{eqnarray}  
      \sum_P D_PQ = \sum_P \int \nabla \phi_P \cdot \nabla \phi_Q = \int \nabla 1 \cdot \nabla \phi_Q = 0
  \end{eqnarray}
  Thus the diagonal elements of matrix D can be obtained by:
    \begin{eqnarray}
      \mathbf{D}_{PP} = -\sum_{P \ne Q}D_PQ \label{diagonalOfD}
    \end{eqnarray}    
    Write each $z_p$ as $z_p=x_p + iy_p$, then
    equation (\ref{allQ}) can be written separately as:
    \begin{eqnarray}
      \sum_{P}x_p D_{PQ} &=& \frac{\partial \Phi(Q)}{\partial u}(P) \nonumber\\
      \sum_{Q}y_p D_{PQ} &=& -\frac{\partial \Phi(Q)}{\partial v} (P)
    \end{eqnarray}  
    denote:
    \begin{eqnarray}
      \vec{a} = (a_Q) &=& \frac{\partial \Phi(Q)}{\partial u}(P) \nonumber \\
      \vec{b} = (b_Q) &=& -\frac{\partial \Phi(Q)}{\partial v} (P)
    \end{eqnarray}  
    so we have:
    \begin{eqnarray}
      \mathbf{D}\vec{x} &=& \vec{a} \nonumber \\
      \mathbf{D}\vec{y} &=& \vec{b} \label{z}
    \end{eqnarray}    
    $\forall \quad point \quad Q$:
    \begin{eqnarray}
      a_Q - ib_Q := \left\{
      \begin{array}{lcl}
        0 & for & Q \notin {A, B, C} \\
        \frac{-1}{||B-A||} + i\frac{1-\theta}{||C-E||} & for & Q = A \\
        \frac{1}{||B-A||} + i\frac{\theta}{||C-E||} & for & Q = B \\
        i\frac{-1}{||C-E||} & for & Q = C
      \end{array} \right. \label{ab}
    \end{eqnarray}      
With vectors $a$, $b$ and matrix $D$, we can solve the linear equation to obtain the mapping.
The matrix $D$ is sparce, symmetric and positive defined, hence is suitable to be solved by conjugated gradient method.

\section{User's Guide}

The conformal flattening filter takes an ITK mesh as input and will generate another mesh as output.
The usage is basically the same as other mesh to mesh filters in ITK.

\subsection{Basic usage}
The filter is instaintiated by:
\begin{verbatim}
  typedef itk::ConformalFlatteningFilter< MeshType, MeshType>  FilterType;
  FilterType::Pointer filter = FilterType::New();
\end{verbatim}
Then the input can be set and result can be obtained by:
\begin{verbatim}
  filter->SetInput( mesh ); 
\end{verbatim}
and
\begin{verbatim}
  newMesh = filter->GetOutput(); 
\end{verbatim}

\subsection{More about APIs}
The filter has two categories of APIs for further manipulation.
The first one is the setPointP function and the second contains two switch functions, mapToPlane and mapToSphere.

On the right side of equation (\ref{pde}), the $\delta_p$ function depands on the location of the point \emph{p}.
Baiscally, this point will be mapped to infinity on the plane and the north-pole of the sphere.
Hence the selection of the point \emph{p} determines which patch on the original mesh is mapped to around the north pole.

The API setPointP takes an integer as input indicating the cell number in which the point \emph{p} lies.
It's a good choice to set the point \emph{p} at the local surface where is relatively flat, i.e., having a small local curvature. 
However the computation of curvature is not trival and can be done by vtkCurvatures. 
To make this filter independent of vtk, this feature is not included in the filter.
If setting the point \emph{p} at some flat area is crucial, 
we suggest that user first use vtkCurvatures to obtain the number of cell having low curvature and then call this function using that cell number.

The switch functions mapToPlane and mapToSphere determine the output to be whether a plane or a sphere, the later one being the default.
The difference between the two is mapping to sphere has an extra step of stereographic projection.
Simply by
\begin{verbatim}
  filter->mapToSphere( ); 
\end{verbatim}
or
\begin{verbatim}
  filter->mapToPlane( ); 
\end{verbatim}
users can switch between two different output.

\section{Examples}

Here we show examples of our filter in action.  We also provide
reviewers with all parameters and data so that they too can
reproduce our results.  This is crucial for a good review.


\section{Conclusions}

Here we summarize our work.


% The preceding sections will have been written in a gentler,
% introductory style.  You may also wish to include a reference
% section, documenting all the functions/exceptions/constants.
% Often, these will be placed in separate files and input like this:



%\appendix
%
%\section{This is an Appendix}
%
%To create an appendix in a Insight HOWTO document, use markup like
%this:
%
%\begin{verbatim}
%\appendix
%
%\section{This is an Appendix}
%
%To create an appendix in a Insight HOWTO document, ....
%
%
%\section{This is another}
%
%Just add another \section{}, but don't say \appendix again.
%\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Example on how to insert a figure
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\begin{figure}
%\center
%\includegraphics[width=0.8\textwidth]{RegistrationComponentsDiagram.eps}
%\itkcaption[Registration Framework Components]{The basic components of the
%registration framework are two input images, a transform, a metric, an
%interpolator and an optimizer.}
%\label{fig:RegistrationComponents}
%\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Example on how to insert an equation.
%  Never forget to put an equation in your paper.
%  They make them look professional and impress the reviewers.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%To support shape-guidance, the generic level set equation
%(Eqn(~\ref{eqn:ShapeInfluenceTerm})) is extended to incorporate a shape guidance
%term:
%
%\begin{equation}
%\label{eqn:ShapeInfluenceTerm}
%\xi \left(\psi^{*}(\mathbf{x}) - \psi(\mathbf{x})\right)
%\end{equation}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Insert the bibliography using BibTeX
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\bibliographystyle{plain}
\bibliography{InsightJournal}


\end{document}
