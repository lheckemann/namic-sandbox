%
% Complete documentation on the extended LaTeX markup used for Insight
% documentation is available in ``Documenting Insight'', which is part
% of the standard documentation for Insight.  It may be found online
% at:
%
%     http://www.itk.org/

\documentclass{InsightArticle}

\usepackage[dvips]{graphicx}
\usepackage{subfigure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  hyperref should be the last package to be loaded.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[dvips,
	bookmarks,
	bookmarksopen,
	backref,
	colorlinks,linkcolor={blue},citecolor={blue},urlcolor={blue},
]{hyperref}


%  This is a template for Papers to the Insight Journal.
%  It is comparable to a technical report format.

% The title should be descriptive enough for people to be able to find
% the relevant document.
\title{Conformal Flattening ITK Filter}

% Increment the release number whenever significant changes are made.
% The author and/or editor can define 'significant' however they like.
\release{0.00}

% At minimum, give your name and an email address.  You can include a
% snail-mail address if you like.
\author{Yi Gao$^{1}$, John Melonakos$^{1}$, and Allen Tannenbaum$^{1}$}
\authoraddress{$^{1}$Georgia Institute of Technology, Atlanta, GA\\
}

\begin{document}

	\newif\ifpdf
	\ifx\pdfoutput\undefined
  \pdffalse
	\else
  \pdfoutput=1
  \pdftrue
	\fi


	\ifpdf
	\else
  %
  % Commands for including Graphics when using latex
  %
  \DeclareGraphicsExtensions{.eps,.jpg,.gif,.tiff,.bmp,.png}
  \DeclareGraphicsRule{.jpg}{eps}{.jpg.bb}{`convert #1 eps:-}
  \DeclareGraphicsRule{.gif}{eps}{.gif.bb}{`convert #1 eps:-}
  \DeclareGraphicsRule{.tiff}{eps}{.tiff.bb}{`convert #1 eps:-}
  \DeclareGraphicsRule{.bmp}{eps}{.bmp.bb}{`convert #1 eps:-}
  \DeclareGraphicsRule{.png}{eps}{.png.bb}{`convert #1 eps:-}
	\fi


	\maketitle


	\ifhtml
	\chapter*{Front Matter\label{front}}
	\fi


	% The abstract should be a paragraph or two long, and describe the
	% scope of the document.
	\begin{abstract}
		\noindent This paper describes the Insight Toolkit (ITK) Conformal
		Flattening filter: itkConformalFlatteningFilter. This ITK filter is an
		implementation of a paper by Sigurd Angenent, et al., ``On the
		Laplace-Beltrami Operator and Brain Surface Flattening''
		\cite{angenent1999lbo}. This filter performs an angle preserving map of any
		genus zero (i.e. no handles) triangulated mesh to the sphere or,
		alternatively, to the plane. In other words, any given triangle in the
		resulting sphere will have the same angles as the corresponding
		triangle in the original mesh, though their areas may differ. In this
		paper, we describe our code and provide the user with enough details
		to reproduce the results which we present in this paper. This filter
		has a variety of applications including the flattening of brain
		surfaces, which was the initial motivation for this work.
	\end{abstract}

	\tableofcontents

	The folding and wrapping of brain surfaces presents researchers with
	difficulties in obtaining a more intuition-based surface
	rendering. In recent years, a number of methods have been proposed
	to map the brain surface to a plane or a sphere. Most of the
	previous methods are derived to preserve local area or length. In
	the paper of Sigurd Angenent, et al., ``On the Laplace-Beltrami
	Operator and Brain Surface Flattening'', an angle preserving
	conformal flattening scheme is proposed.

	The algorithm obtains the explicit form of the flattening map by
	solving a partial differential equation on the surface using the
	finite element method (FEM). The mapping is a bijection and the
	original structure can be restored by inverse mapping.

	\section{Algorithm Details}

	\subsection{Mathematical manipulation}
  Denote the genus zero surface which is to be flattened as $\Sigma$.
  $\Sigma$ can be mapped to a plane using the algorithm proposed in
  \cite{angenent1999lbo}. The mapping is conformal thus the angles are
  preserved. Furthermore, the plane can be mapped to a sphere, using
  standard stereographic projection.
  
  It is proven in the appendix of \cite{angenent1999lbo} that the mapping
  $z$, defined on $\Sigma$, satisfying is the following:
  \begin{eqnarray}
    \triangle z = (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p 
    \label{pde}
  \end{eqnarray}
  
  where $p$ is an (arbitrary) point on $\Sigma$. The funtion $z$ maps
  $\Sigma \backslash \{p\}$ to the complex plane $\mathbf{C}$. Then by
  standard sterographic projection, the complex plane is mapped to a
  sphere excluding only the north pole.

  \subsection{Numerical scheme}
  The mapping $z$ is defined on the surface. In the numerical
  manipulation where the surface is denoted as a triangulated mesh,
  solving of the equation (\ref{pde}) is carried out by FEM.
  
  In the discrete configuration, $z$ is approximated by a piecewise
  linear function on the triangulated mesh. Denote the
  finite-dimensional space $PL(\Sigma)$ of piecewise linear functions
  on $\Sigma$. To solve equation (\ref{pde}), first its right side
  should be approximated. For any function $f$ smooth in a
  neighborhood of $p$,
  \begin{eqnarray}
    && \int\int_{\Sigma} f (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p \mathrm{d}S \nonumber \\
    &=& - \int\int_{\Sigma}(\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})f \delta_p(w) \mathrm{d}S \nonumber \\
    &=& -(\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})\delta_p \label{rightSideOfPDE}
  \end{eqnarray}  
  Thus $\forall f \in PL(\Sigma)$, given that the point $p$ lies in
  the cell composed by three points $A$, $B$, and $C$, the quantity of
  (\ref{rightSideOfPDE}) is determined by the values of $f$ on $A$,
  $B$, and $C$.
  
  On the triangle $\triangle ABC$, choose the $u$ and $v$ axes such
  that $A$ and $B$ are along $u$ axis and the positive direction of
  axis $v$ is pointing to the point $C$. So,
  \begin{eqnarray}    
    \frac{\partial f}{\partial u} &=& \frac{f_B - f_A}{||B - A||} \nonumber \\
    \frac{\partial f}{\partial v} &=& \frac{f_C - f_E}{||C - E||} \nonumber
  \end{eqnarray}  
  in which E is the orthogonal projection of $C$ on $AB$ and can be
  computed by:
  \begin{eqnarray}  
    E = A + \theta(B-A) \nonumber
  \end{eqnarray}  
  where
  \begin{eqnarray}  
    \theta = \frac{<C-A, B-A>}{||B-A||^2} \nonumber
  \end{eqnarray}  
  in which $<,>$ denotes inner product.
  
  Thus $\forall f \in PL(\Sigma)$, 
  \begin{eqnarray}  
    (\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})\delta_p = 
    \frac{f_A - f_B}{|| B - A ||} + i\frac{f_c-(f_A + \theta(f_B - f_A))}{||C - E||} \label{Rinteqn}
  \end{eqnarray}  
  
  Next we are going to perform the finite element solution of the
  mapping in the function space $PL(\Sigma)$.
  
  FEM theory indicates that the solver function $z=x+iy$ for equation
  (\ref{pde}) is the minimizer of the Dirichlet functional:
  \begin{eqnarray}  
    \mathbf{D}(z):=\frac{1}{2}\int\int_{\Sigma}[ |\nabla z|^2 + 2z (\frac{\partial}{\partial u} - i\frac{\partial}{\partial v})\delta_p ]\mathrm{d}S \label{DirichletFunctional}
  \end{eqnarray}      
  $z$ satisfies equation(\ref{pde}) if and only if $\forall$ smooth
  function $f$,
  \begin{eqnarray}  
    \int\int_{\Sigma} \nabla z \cdot \nabla f \mathrm{d}S = (\frac{\partial f}{\partial u} - i\frac{\partial f}{\partial v})|_p \label{FEM}
  \end{eqnarray}    
  To find the function in $PL(\Sigma)$ satisfying equation(\ref{FEM}),
  we define a set of basis $\phi_P$ in the $PL(\Sigma)$ as,
  \begin{eqnarray}  
    \phi_P(P) &=& 1 \nonumber \\
    \phi_P(Q) &=& 0, \forall Q \ne P \nonumber \\
    \phi_P(P) && is \quad linear \quad on \quad each \quad triangle \label{basis}
  \end{eqnarray}  
  Then function $z$ can be expressed as a linear combination of the
  basis:
  \begin{eqnarray}  
    z = \sum_{P:\quad vertex \quad of \quad \Sigma} z_P \phi_P \label{zInBasis}
  \end{eqnarray}  
  By this we convert the original problem into solving for the complex
  vector $\vec{z}=(z_P)$:
  \begin{eqnarray}  
    \sum_P z_P \int\int \nabla \phi_P \cdot \nabla \phi_Q \mathrm{d}S = \frac{\partial \phi_Q}{\partial u}(p) - i \frac{\partial \phi_Q}{\partial v}(p)
    \label{allQ}
  \end{eqnarray}  
  Denote matrix $D_{PQ}$ as
  \begin{eqnarray}  
    D_{PQ} = \int\int \nabla \phi_P \cdot \nabla \phi_Q \mathrm{d}S  \label{Dpq}
  \end{eqnarray}  
  The off-diagonal elements of $D$ can be computed by:
  \begin{eqnarray}  
    \{ \mathbf{D} \}_{P,Q } = -\frac{1}{2}(ctg\angle R + ctg\angle S), \quad P \ne Q  \label{ctg}
  \end{eqnarray}  
  \begin{figure}
		\begin{center}
			\includegraphics[width=7cm]{PntPQRS.eps} \caption{Triangle} \label{PntPQRS}
    \end{center}
  \end{figure}  
  The points are illustrated in figure (\ref{PntPQRS}).  
  
  Also, since
  \begin{eqnarray}  
    \sum_P D_PQ = \sum_P \int \nabla \phi_P \cdot \nabla \phi_Q = \int \nabla 1 \cdot \nabla \phi_Q = 0
  \end{eqnarray}
  Thus the diagonal elements of matrix D can be obtained by:
  \begin{eqnarray}
    \mathbf{D}_{PP} = -\sum_{P \ne Q}D_PQ \label{diagonalOfD}
  \end{eqnarray}    
  Write each $z_p$ as $z_p=x_p + iy_p$, then
  equation (\ref{allQ}) can be written separately as:
  \begin{eqnarray}
    \sum_{P}x_p D_{PQ} &=& \frac{\partial \Phi(Q)}{\partial u}(P) \nonumber\\
    \sum_{Q}y_p D_{PQ} &=& -\frac{\partial \Phi(Q)}{\partial v} (P)
  \end{eqnarray}  
  denote:
  \begin{eqnarray}
    \vec{a} = (a_Q) &=& \frac{\partial \Phi(Q)}{\partial u}(P) \nonumber \\
    \vec{b} = (b_Q) &=& -\frac{\partial \Phi(Q)}{\partial v} (P)
  \end{eqnarray}  
  so we have:
  \begin{eqnarray}
    \mathbf{D}\vec{x} &=& \vec{a} \nonumber \\
    \mathbf{D}\vec{y} &=& \vec{b} \label{z}
  \end{eqnarray}    
  $\forall \quad point \quad Q$:
  \begin{eqnarray}
    a_Q - ib_Q := \left\{
    \begin{array}{lcl}
      0 & for & Q \notin {A, B, C} \\
      \frac{-1}{||B-A||} + i\frac{1-\theta}{||C-E||} & for & Q = A \\
      \frac{1}{||B-A||} + i\frac{\theta}{||C-E||} & for & Q = B \\
      i\frac{-1}{||C-E||} & for & Q = C
    \end{array} \right. \label{ab}
  \end{eqnarray}      
	With vectors $a$, $b$, and matrix $D$, we can solve the linear
	equation to obtain the mapping. The matrix $D$ is sparce, symmetric
	and positively defined, hence is suitable to being solved by the
	conjugate gradient method.

	\section{User's Guide}

	The conformal flattening filter takes an ITK mesh as input and will
	generate another ITK mesh as output. The usage is basically the same
	as other mesh to mesh filters in ITK.

	\subsection{Basic usage}
	The filter is instaintiated by:
	\begin{verbatim}
		typedef itk::ConformalFlatteningFilter< MeshType, MeshType>  FilterType;
		FilterType::Pointer filter = FilterType::New();
	\end{verbatim}
	Then the input can be set and results can be obtained by:
	\begin{verbatim}
		filter->SetInput( mesh ); 
	\end{verbatim}
	and
	\begin{verbatim}
		newMesh = filter->GetOutput(); 
	\end{verbatim}

	\subsection{More about APIs}
	The filter has two categories of APIs for further manipulation. The
	first one is the setPointP function and the second contains two switch
	functions, mapToPlane and mapToSphere.

	On the right side of equation (\ref{pde}), the $\delta_p$ function
	depands on the location of the point \emph{p}. Basically, this point
	will be mapped to infinity on the plane and the north-pole of the
	sphere. Hence the selection of the point \emph{p} determines which
	patch on the original mesh is mapped up to the north pole.

	The API setPointP takes an integer as input indicating the cell number
	in which the point \emph{p} lies. It's a good choice to set the point
	\emph{p} where the local surface is relatively flat, i.e., having a
	small local curvature. However the computation of curvature can be
	done by the vtkCurvatures filter. In order to make this filter
	independent of VTK, this feature is not included in the filter and is
	left to the user. If setting the point \emph{p} at some flat area is
	crucial, we suggest that user first use vtkCurvatures to obtain the
	number of cells having low curvatures and then call this function
	using one of the cells with a low curvature.

	The switch functions mapToPlane and mapToSphere determine the output
	to be either a plane or a sphere, the sphere being the default. The
	difference between the two mappings is simply a stereographic
	projection from the plane to the sphere. Simply by
	\begin{verbatim}
		filter->mapToSphere( ); 
	\end{verbatim}
	or
	\begin{verbatim}
		filter->mapToPlane( ); 
	\end{verbatim}
	users can switch between two different outputs.

	\section{The Filter Test}
  This section contains details about the test we include with the
  submission of this ITK filter. We have provided $nice.vtk$ which is
  a synthetic genus zero mesh. We set this as the single input to the
  itkConformalFlatteningFilterTest, as follows:

	\begin{verbatim}
		> ./itkConformalFlatteningFilterTest nice.vtk
	\end{verbatim}

  \noindent In Figure~\ref{fig:original}, we show the original
  $nice.vtk$ data, which is colored according to mean curvature. In
  Figure~\ref{fig:nice}, we show the surface view and in
  Figure~\ref{fig:nice-mesh}, we show the triangulated mesh.

  \begin{figure}[t]
		\begin{center}
			\subfigure[Original Surface]{\includegraphics[width=5cm]{nice.eps} \label{fig:nice}}
			\subfigure[Original Mesh]{\includegraphics[width=5cm]{nice-mesh.eps} \label{fig:nice-mesh}}
    \end{center}
    \vspace{-.25in} \caption{The Original Data} \label{fig:original}
  \end{figure}  

  In Figure~\ref{fig:results}, we show the results of the filter. The
  coloring provides a convenient visual mapping from the original mesh
  to the sphere. In Figure~\ref{fig:nice-flat}, we show the surface
  view of the sphere and in Figure~\ref{fig:nice-flat-mesh}, we show
  the triangulated mesh on the sphere.

  \begin{figure}[h]
		\begin{center}
			\subfigure[Flattened Surface]{\includegraphics[width=5cm]{nice-flat.eps} \label{fig:nice-flat}}
			\subfigure[Flattened Mesh]{\includegraphics[width=5cm]{nice-flat-mesh.eps} \label{fig:nice-flat-mesh}}
    \end{center}
    \vspace{-.25in} \caption{The Results} \label{fig:results}
  \end{figure}  

  In order to reproduce our results, the reader should compile and run
  our code with the following packages (though the code will likely
  compile and run with other variants, including CVS checkouts, of
  CMake, ITK, and VTK):

  \begin{verbatim}
  CMake 2.2.3
  ITK 2.4.1
  VTK 4.4.2
  \end{verbatim}

  We have also included the results presented here as the
  $niceFlat.vtk$ file included in this submission. One can verify the
  angle preserving nature of this filter by comparing ratios of edge
  lengths between triangles in the original surface and the
  corresponding triangles in the flattened mesh.

	\section{Future Applications}
  We propose to use this filter to conformally flatten brain
  surfaces. In order to accomplish this, we are currently
  investigating automated methods for extracting genus zero brain
  surfaces from raw MRI volumes.

  We have tried a variety of brain extraction (skull-removing) tools,
  including FreeSurfer, BET, MRIcro, ITKSNAP, and other ITK levelset
  filters and have been able to extract brain surface meshes using
  these tools. However, thus far, we have been unsuccessful in
  obtaining a genus zero surface without significant manual editing,
  using these tools. We are hopeful that topology preserving levelset
  algorithms will soon become part of ITK to facilitate our work, but
  the development of this filter is beyond the scope of this paper. We
  are also aware of topology correction algorithms which perform
  cutting operations to convert any genus surfaces into genus zero
  surfaces. We will also investigate the use of these algorithms to
  extract genus zero brain surfaces.

  \begin{figure}[h]
		\begin{center}
			\subfigure[Original Brain Surface]{\includegraphics[width=5cm]{brain.eps} \label{fig:brain}}
			\subfigure[Flattened Brain Surface]{\includegraphics[width=5cm]{brain-flat.eps} \label{fig:brain-flat}}
    \end{center}
    \vspace{-.25in} \caption{Preliminary Brain Surface Results}
  \end{figure}  

  As described above, through the use of various open-source tools and
  a fair amount of manual editing, we were able to obtain a genus zero
  surface of the brain which we show in
  Figure~\ref{fig:brain}. Preliminary results of running the
  itkConformalFlatteningFilterTest on $brain.vtk$ can be seen in
  Figure~\ref{fig:brain-flat}. Note that the coloring is not optimal
  since the coloring parameters in the test filter have been optimized
  for the $nice.vtk$ test file. In the future, we will optimize the
  coloring scheme for brain surfaces so that brain surface meshes
  mapped to the sphere will provide nice visual insights into the
  contours of brain sulci and gyri.

	\section{Conclusions}
	In this paper, we have described the Insight Toolkit (ITK) Conformal
	Flattening filter: itkConformalFlatteningFilter. This ITK filter is
	an implementation of a paper by Sigurd Angenent, et al., ``On the
	Laplace-Beltrami Operator and Brain Surface Flattening''
	\cite{angenent1999lbo}. This filter performs an angle preserving map
	of any genus zero (i.e. no handles) triangulated mesh to the sphere
	or, alternatively, to the plane.

	We have provide the user with details to be able to reproduce our
	results. We have also given suggestions as to how to exploit the
	full functionality of this filter.

	In the future, we propose to use this filter to map entire brain
	surfaces to the sphere. Perhaps clinical studies of the resulting
	flattened map with yield insights into brain anatomy and function.



	% The preceding sections will have been written in a gentler,
	% introductory style.  You may also wish to include a reference
	% section, documenting all the functions/exceptions/constants.
	% Often, these will be placed in separate files and input like this:



	%\appendix
	%
	%\section{This is an Appendix}
	%
	%To create an appendix in a Insight HOWTO document, use markup like
	%this:
	%
	%\begin{verbatim}
	%\appendix
	%
	%\section{This is an Appendix}
	%
	%To create an appendix in a Insight HOWTO document, ....
	%
	%
	%\section{This is another}
	%
	%Just add another \section{}, but don't say \appendix again.
	%\end{verbatim}


	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%
	%  Example on how to insert a figure
	%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	%\begin{figure}
	%\center
	%\includegraphics[width=0.8\textwidth]{RegistrationComponentsDiagram.eps}
	%\itkcaption[Registration Framework Components]{The basic components of the
	%registration framework are two input images, a transform, a metric, an
	%interpolator and an optimizer.}
	%\label{fig:RegistrationComponents}
	%\end{figure}



	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%
	%  Example on how to insert an equation.
	%  Never forget to put an equation in your paper.
	%  They make them look professional and impress the reviewers.
	%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


	%To support shape-guidance, the generic level set equation
	%(Eqn(~\ref{eqn:ShapeInfluenceTerm})) is extended to incorporate a shape guidance
	%term:
	%
	%\begin{equation}
	%\label{eqn:ShapeInfluenceTerm}
	%\xi \left(\psi^{*}(\mathbf{x}) - \psi(\mathbf{x})\right)
	%\end{equation}




	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%
	%  Insert the bibliography using BibTeX
	%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	\bibliographystyle{plain}
	\bibliography{itkConformalFlattening06-IJ}


\end{document}
